# Experimental Serialization Formats

This document describes the experimental support for additional serialization formats in mkunion beyond the default JSON format.

## Overview

mkunion now supports generating serialization code for multiple formats:

- **JSON** (default) - Standard JSON marshaling/unmarshaling
- **Protobuf** - Protocol Buffers with gRPC support
- **SQL** - Database operations with `sql.Scanner` and `sql.Valuer` interfaces
- **GraphQL** - Schema definitions and resolver templates

## Usage

### CLI Flags

Use the `--serde-formats` flag to specify which serialization formats to generate:

```bash
# Generate all formats
mkunion --serde-formats json,protobuf,sql,graphql -i myfile.go

# Generate only specific formats
mkunion --serde-formats protobuf,graphql -i myfile.go

# Default behavior (JSON only)
mkunion -i myfile.go
```

The flag also works with the `watch` command:

```bash
mkunion watch --serde-formats json,protobuf,sql ./...
```

### Generated Files

Each format generates its own file with the appropriate suffix:

- `*_serde_gen.go` - JSON serialization (existing)
- `*_protobuf_gen.go` - Protobuf serialization
- `*_sql_gen.go` - SQL serialization
- `*_graphql_gen.go` - GraphQL schemas and resolvers

## Format Details

### Protobuf Support

Generates basic Protobuf support:

- **Tagged types**: Implements `proto.Message` interface with `Marshal()` and `Unmarshal()` methods
- **Union types**: Creates enum-based message types with type discriminator fields

Example generated code:
```go
var (
    _ proto.Message = (*MyStruct)(nil)
)

func (r *MyStruct) Marshal() ([]byte, error) {
    return proto.Marshal(r)
}
```

### SQL Support

Generates database-compatible serialization:

- **Tagged types**: Implements `sql.Scanner` and `sql.Valuer` interfaces
- **Union types**: Provides DDL comments, scanning functions, and type conversion utilities

Example generated code:
```go
var (
    _ sql.Scanner = (*MyStruct)(nil)
    _ sql.Valuer  = (*MyStruct)(nil)
)

func (r *MyStruct) Scan(value interface{}) error {
    // Implementation
}

func (r *MyStruct) Value() (sql.Value, error) {
    // Implementation
}
```

### GraphQL Support

Generates GraphQL schemas and resolver templates:

- **Tagged types**: Creates GraphQL type definitions with field mappings
- **Union types**: Generates union/interface schemas with variant types

Example generated code:
```go
/*
GraphQL Schema for MyStruct:

type MyStruct {
  field1: String!
  field2: Int!
}

Example Resolver:
func (r *queryResolver) GetMyStruct(ctx context.Context, id string) (*MyStruct, error) {
    return &MyStruct{}, nil
}
*/
```

## Examples

### Basic Struct

Input:
```go
//go:tag serde:"json"
type Point struct {
    X float64 `json:"x"`
    Y float64 `json:"y"`
}
```

Command:
```bash
mkunion --serde-formats protobuf,sql,graphql -i example.go
```

This generates three additional files with Protobuf, SQL, and GraphQL support.

### Union Type

Input:
```go
//go:tag mkunion:"Shape"
type (
    Circle struct {
        Radius float64
    }
    Rectangle struct {
        Width  float64
        Height float64
    }
)
```

The generated code includes serialization support for the union type in all requested formats.

## Implementation Status

This feature is **experimental** and provides a foundation for multi-format serialization support. The implementations are basic but functional:

- âœ… Basic code generation working
- âœ… CLI integration complete
- âœ… Test coverage included
- ðŸ”„ Advanced features and optimizations pending
- ðŸ”„ Full ecosystem integration pending

## Future Enhancements

Planned improvements include:

1. **Protobuf**: Full `.proto` file generation, advanced field options
2. **SQL**: Advanced type mapping, query builders, migration support
3. **GraphQL**: Schema stitching, advanced resolver patterns, subscription support
4. **Additional formats**: YAML, TOML, MessagePack, Avro

## Migration and Compatibility

The default behavior remains unchanged - JSON serialization is generated by default. The experimental formats are opt-in and do not affect existing code generation.

To gradually adopt the new formats:

1. Start with `--serde-formats json,protobuf` to add Protobuf alongside JSON
2. Test the generated code in your application
3. Add additional formats as needed

## Troubleshooting

### Common Issues

1. **Missing imports**: The generated code may require additional dependencies
   - Protobuf: `google.golang.org/protobuf/proto`
   - SQL: `database/sql/driver`

2. **Type compatibility**: Some complex types may not translate perfectly to all formats
   - Check generated comments for format-specific limitations

3. **Build errors**: Ensure all required dependencies are available
   - Run `go mod tidy` after generation

### Getting Help

For issues or questions about experimental serialization formats:

1. Check this documentation
2. Review generated code comments
3. File issues with the `experimental` label